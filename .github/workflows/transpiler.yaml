name: Transpiler

# specs:
# - if a new rootfile[s] is added, the timestamp should be the most recent one
#  - for that rootfile, find the clostest caliber and run the transpiler on it
#  - if the transpiler fails, the PR should fail
#  - if the transpiler succeeds, compare that with the current rootfile
#  - if the new rootfile is different, the PR should fail
#  - if the new rootfile is the same, the PR should pass

on:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-run-transpiler:
    name: Verify new rootfiles correctness with the transpiler
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout config repo
        uses: actions/checkout@v5

      - name: Get changed rootfiles files
        id: changed-rootfiles
        uses: tj-actions/changed-files@ed68ef82c095e0d48ec87eccea555d944a631a4c # v46
        with:
          files: machines/**/rootfiles/**.toml

      # We don't allow anyone to modify existing rootfiles, only to add new ones.
      - name: Reject PR if existing rootfiles are modified
        if: steps.changed-rootfiles.outputs.modified_files_count > 0
        env:
          MODIFIED_ROOTFILES: ${{ steps.changed-rootfiles.outputs.modified_files }}
        run: |
          for file in ${MODIFIED_ROOTFILES}; do
            echo "Error: $file was modified. Existing rootfiles are not allowed to be modified."
          done
          exit 1

      # Rootfiles filename format: YYYYMMDDHHMMSS-<name>.toml
      # New rootfiles should start with the most recent timestamp in the directory
      # [naive alphabetical order - not checking YYYYMMDD format]
      - name: Verify new rootfiles filename format
        if: steps.changed-rootfiles.outputs.added_files_count > 0
        env:
          ADDED_ROOTFILES: ${{ steps.changed-rootfiles.outputs.added_files }}
        run: |
          # Note: when multiple rootfiles are added in the same directory (e.g. an older "empty"
          # and a newer actionable rootfile), it's impossible for *every* added rootfile
          # to be the most recent. Instead, enforce that for each touched directory,
          # the most recent rootfile (lexicographically greatest) is part of the PR.

          declare -A dir_top=()

          # Compute the most recent filename per rootfiles directory.
          for file in ${ADDED_ROOTFILES}; do
            dir=$(cd -- "$(dirname -- "$file")" && pwd)

            if [[ -z "${dir_top[$dir]:-}" ]]; then
              top=$(
                cd -- "$dir"
                LC_ALL=C ls -1Ap | grep -v '/$' | LC_ALL=C sort -r | head -n 1
              )
              dir_top["$dir"]="$top"
            fi
          done

          # Ensure that the most recent file in each directory is among the added files.
          for dir in "${!dir_top[@]}"; do
            top="${dir_top[$dir]}"
            found=0

            for file in ${ADDED_ROOTFILES}; do
              file_dir=$(cd -- "$(dirname -- "$file")" && pwd)
              base=$(basename -- "$file")

              if [[ "$file_dir" == "$dir" && "$base" == "$top" ]]; then
                found=1
                break
              fi
            done

            if [[ "$found" -ne 1 ]]; then
              echo "Error: New rootfiles were added in '$dir', but none is the most recent rootfile ('$top')." >&2
              exit 1
            fi
          done

      - name: Checkout transpiler repository
        uses: actions/checkout@v5
        with:
          repository: MakinaHQ/transpiler
          path: transpiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: transpiler

      - name: Build transpiler
        working-directory: transpiler
        run: cargo build --release

      - name: Run transpiler
        working-directory: transpiler
        env:
          ADDED_ROOTFILES: ${{ steps.changed-rootfiles.outputs.added_files }}
        run: |
          for file in ${ADDED_ROOTFILES}; do
            caliber="../$(dirname "$(dirname "$file")")/caliber.yaml"
            new_file="../$(dirname "$file")/generated.toml"
            tokenlist="../addresses/tokens/tokenlist.json"
            echo "Running transpiler for $caliber - to verify $file rootfile"
            cargo run -r -- -i "$caliber" -o "$new_file" -t "$tokenlist"
            diff "../$file" "$new_file" || exit 1
            rm "$new_file"
          done
